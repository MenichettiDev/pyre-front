<div class="cbo-wrapper">
    <!-- Conditional Label -->
    <label *ngIf="isLabel" [for]="isId" class="form-label">
        {{ isLabel }}
        <span *ngIf="objectErrors?.required" class="required-indicator">*</span>
    </label>

    <!-- Search input container -->
    <div class="search-container" [class.has-error]="hasErrors()" [class.is-expanded]="isOpen">
        <div class="search-input-group">
            <!-- Main input - readonly when collapsed, editable when expanded -->
            <input [id]="isId" [value]="isOpen ? (searchControl.value || '') : placeholder" [disabled]="isDisabled"
                [readonly]="!isOpen" [class.error]="hasErrors()" class="search-input" (click)="onMainInputClick()"
                (focus)="onMainInputFocus()" (blur)="onMainInputBlur()" (input)="onMainInputChange($event)"
                autocomplete="off" />

            <!-- Clear button -->
            <button *ngIf="selectedTipoMovimiento && !isDisabled && isOpen" type="button" class="clear-button"
                (click)="clearSelection()" title="Limpiar selecciÃ³n">
                <i class="pi pi-times"></i>
            </button>

            <!-- Loading spinner -->
            <div *ngIf="isLoading" class="loading-spinner">
                <i class="pi pi-spinner pi-spin"></i>
            </div>

            <!-- Dropdown arrow -->
            <div *ngIf="!isLoading" class="dropdown-arrow" (click)="toggleDropdown($event)">
                <i class="pi pi-chevron-down" [class.rotated]="isOpen"></i>
            </div>
        </div>

        <!-- Dropdown options -->
        <div *ngIf="isOpen && !isDisabled" class="dropdown-panel">
            <div class="dropdown-content">
                <!-- No results message -->
                <div *ngIf="tiposMovimiento.length === 0 && !isLoading" class="no-results">
                    <span *ngIf="searchControl.value && searchControl.value.length < 2">
                        Ingrese al menos 2 caracteres para buscar
                    </span>
                    <span *ngIf="searchControl.value && searchControl.value.length >= 2">
                        No se encontraron tipos de movimiento
                    </span>
                    <span *ngIf="!searchControl.value">
                        No hay tipos de movimiento disponibles
                    </span>
                </div>

                <!-- Options list -->
                <div *ngFor="let tipoMovimiento of tiposMovimiento; trackBy: trackByTipoMovimiento"
                    class="dropdown-option" [class.selected]="selectedTipoMovimiento?.id === tipoMovimiento.id"
                    (click)="onOptionClick(tipoMovimiento)">
                    <div class="option-content">
                        <div class="option-main">
                            <span class="option-nombre">{{ tipoMovimiento.nombre }}</span>
                            <span *ngIf="!tipoMovimiento.activo" class="option-status-inactive">Inactivo</span>
                        </div>
                        <div class="option-details"
                            *ngIf="tipoMovimiento.descripcion && tipoMovimiento.descripcion !== tipoMovimiento.nombre">
                            <span class="option-descripcion">{{ tipoMovimiento.descripcion }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error message -->
    <div *ngIf="hasErrors()" class="error-message">
        {{ getErrorMessage() }}
    </div>

    <!-- Loading indicator -->
    <div *ngIf="isLoading && !isOpen" class="loading-indicator">
        <i class="pi pi-spinner pi-spin"></i>
        <span>Cargando...</span>
    </div>
</div>