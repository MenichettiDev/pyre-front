<div class="modal-overlay" *ngIf="visible" role="dialog" aria-modal="true">
  <div class="modal-wrapper" [class.readonly]="!editingEnabled">
    <div class="modal-content" [class.open]="visible">
      <div class="modal-header">
        <h3>{{ mode === 'edit' ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
        <span *ngIf="mode === 'edit' && !editingEnabled" class="readonly-badge">Solo lectura</span>
        <button class="close-btn" (click)="onCancel()" aria-label="Cerrar">
          <span class="pi pi-times" aria-hidden="true"></span>
        </button>
      </div>

      <!-- ⏳ Indicador de loading para modo edición -->
      <div *ngIf="mode === 'edit' && !initialData" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Cargando datos del usuario...</p>
      </div>

      <!-- Dummy hidden inputs to reduce browser autofill on email/password -->
      <form *ngIf="mode === 'create' || initialData" [formGroup]="form" (ngSubmit)="onSubmit()" class="modal-form" autocomplete="off">
        <input type="text" name="fakeusernameremembered" autocomplete="username" style="display:none" />
        <input type="password" name="fakepasswordremembered" autocomplete="new-password" style="display:none" />
        <!-- Grid compacto de campos -->
        <div class="compact-form-grid">
          <!-- Fila 1: Información básica -->
          <div class="field-group" [class.has-error]="form.get('Nombre')?.invalid && form.get('Nombre')?.touched">
            <label class="required">Nombre</label>
            <input formControlName="Nombre" placeholder="Ingresa el nombre" [class.error]="form.get('Nombre')?.invalid && form.get('Nombre')?.touched" />
            <div *ngIf="form.get('Nombre')?.invalid && form.get('Nombre')?.touched" class="error-text">El nombre es requerido</div>
          </div>

          <div class="field-group" [class.has-error]="form.get('Apellido')?.invalid && form.get('Apellido')?.touched">
            <label class="required">Apellido</label>
            <input formControlName="Apellido" placeholder="Ingresa el apellido" [class.error]="form.get('Apellido')?.invalid && form.get('Apellido')?.touched" />
            <div *ngIf="form.get('Apellido')?.invalid && form.get('Apellido')?.touched" class="error-text">El apellido es requerido</div>
          </div>

          <div class="field-group" [class.has-error]="form.get('Dni')?.invalid && form.get('Dni')?.touched">
            <label class="required">DNI</label>
            <input formControlName="Dni" placeholder="12345678" [class.error]="form.get('Dni')?.invalid && form.get('Dni')?.touched" />
            <div *ngIf="form.get('Dni')?.invalid && form.get('Dni')?.touched" class="error-text">El DNI es requerido</div>
          </div>

          <!-- Fila 2: Contacto y acceso -->
          <div class="field-group full-width" [class.has-error]="form.get('Email')?.invalid && form.get('Email')?.touched">
            <label class="required">Email</label>
            <input formControlName="Email" type="email" placeholder="usuario@empresa.com" [class.error]="form.get('Email')?.invalid && form.get('Email')?.touched" />
            <div *ngIf="form.get('Email')?.invalid && form.get('Email')?.touched" class="error-text">
              <span *ngIf="form.get('Email')?.errors?.['required']">El email es requerido</span>
              <span *ngIf="form.get('Email')?.errors?.['email']">Formato de email inválido</span>
            </div>
          </div>

          <div class="field-group">
            <label class="optional">Teléfono</label>
            <input formControlName="Telefono" type="tel" placeholder="11 2345-6789" />
          </div>

          <div class="field-group" [class.has-error]="form.get('Legajo')?.invalid && form.get('Legajo')?.touched">
            <label class="required">Legajo</label>
            <input formControlName="Legajo" placeholder="ABC001" [class.error]="form.get('Legajo')?.invalid && form.get('Legajo')?.touched" />
            <div *ngIf="form.get('Legajo')?.invalid && form.get('Legajo')?.touched" class="error-text">El legajo es requerido</div>
          </div>

          <div class="field-group" [class.has-error]="form.get('RolId')?.invalid && form.get('RolId')?.touched">
            <label class="required">Rol</label>
            <select formControlName="RolId" [class.error]="form.get('RolId')?.invalid && form.get('RolId')?.touched">
              <option value="" disabled>Selecciona un rol</option>
              <option *ngFor="let r of rolesList" [value]="r.id">{{ r.label }}</option>
            </select>
            <div *ngIf="form.get('RolId')?.invalid && form.get('RolId')?.touched" class="error-text">Selecciona un rol</div>
          </div>

          <!-- Fila 3: Contraseñas -->
          <div class="field-group" [class.has-error]="form.get('Password')?.invalid && form.get('Password')?.touched">
            <label [class.required]="mode === 'create'">
              Contraseña
              <span *ngIf="mode === 'edit'" class="optional-text">(opcional)</span>
            </label>
            <div class="input-with-icon">
              <input
                [type]="showPassword ? 'text' : 'password'"
                formControlName="Password"
                autocomplete="new-password"
                placeholder="Mínimo 6 caracteres"
                [class.error]="form.get('Password')?.invalid && form.get('Password')?.touched"
              />
              <button type="button" class="icon-btn" (click)="showPassword = !showPassword" [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                <span [class]="showPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"></span>
              </button>
            </div>
            <div *ngIf="form.get('Password')?.invalid && form.get('Password')?.touched" class="error-text">
              <span *ngIf="form.get('Password')?.errors?.['required']">La contraseña es requerida</span>
              <span *ngIf="form.get('Password')?.errors?.['minlength']">Mínimo 6 caracteres</span>
              <span *ngIf="form.get('Password')?.errors?.['mismatch']">Las contraseñas no coinciden</span>
            </div>
          </div>

          <div class="field-group" [class.has-error]="form.get('PasswordConfirm')?.invalid && form.get('PasswordConfirm')?.touched">
            <label [class.required]="mode === 'create'">
              Confirmar Contraseña
              <span *ngIf="mode === 'edit'" class="optional-text">(opcional)</span>
            </label>
            <div class="input-with-icon">
              <input
                [type]="showConfirm ? 'text' : 'password'"
                formControlName="PasswordConfirm"
                autocomplete="new-password"
                placeholder="Repite la contraseña"
                [class.error]="form.get('PasswordConfirm')?.invalid && form.get('PasswordConfirm')?.touched"
              />
              <button type="button" class="icon-btn" (click)="showConfirm = !showConfirm" [attr.aria-label]="showConfirm ? 'Ocultar confirmación' : 'Mostrar confirmación'">
                <span [class]="showConfirm ? 'pi pi-eye-slash' : 'pi pi-eye'"></span>
              </button>
            </div>
            <div *ngIf="form.get('PasswordConfirm')?.invalid && form.get('PasswordConfirm')?.touched" class="error-text">
              <span *ngIf="form.get('PasswordConfirm')?.errors?.['required']">Confirma la contraseña</span>
              <span *ngIf="form.get('PasswordConfirm')?.errors?.['mismatch']">Las contraseñas no coinciden</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn-cancel" (click)="onCancel()">Cancelar</button>
          <!-- En modo edit mostramos botón Editar que activa campos, y luego el submit actualizará -->
          <button *ngIf="mode === 'edit' && !editingEnabled" type="button" class="btn-edit" (click)="enableEditing()">Editar</button>
          <button *ngIf="mode === 'edit' && editingEnabled" type="submit" class="btn-submit">Actualizar</button>
          <button *ngIf="mode !== 'edit'" type="submit" class="btn-submit">Crear</button>
        </div>
      </form>
    </div>
  </div>
</div>
