<!-- COMPONENTE PRÉSTAMO MEJORADO - HTML -->
<div class="container-fluid mt-4 prestamo-container">
  <div class="row g-4 d-flex align-items-stretch">
    <!-- FORMULARIO PRINCIPAL -->
    <div class="col-lg-8">
      <div class="card prestamo-form-card shadow-sm">
        <!-- Header del formulario con indicador de progreso -->
        <div class="card-header border-0 bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-clipboard-check text-primary me-2"></i>
              Datos del Préstamo
            </h5>
            <div class="form-progress">
              <span class="badge bg-light text-dark border">
                <i
                  class="bi bi-check-circle-fill text-success me-1"
                  *ngIf="prestamoForm.valid"
                ></i>
                <i
                  class="bi bi-hourglass-split text-warning me-1"
                  *ngIf="!prestamoForm.valid"
                ></i>
                {{ getFormCompletionPercentage() }}% completado
              </span>
            </div>
          </div>
          <!-- Barra de progreso visual -->
          <div class="progress mt-3" style="height: 4px">
            <div
              class="progress-bar bg-success transition-smooth"
              role="progressbar"
              [style.width.%]="getFormCompletionPercentage()"
              [attr.aria-valuenow]="getFormCompletionPercentage()"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>

        <div class="card-body p-4 d-flex flex-column">
          <form
            [formGroup]="prestamoForm"
            (ngSubmit)="onSubmit()"
            class="flex-grow-1"
          >
            <!-- SECCIÓN 1: Selección de Herramienta y Responsable -->
            <div class="mb-4">
              <h6 class="form-section-title">
                <i class="bi bi-1-circle-fill text-primary me-2"></i>
                Herramienta y Responsable
              </h6>
              <div class="row g-3">
                <!-- Label -->
                <div class="col-12">
                  <label class="form-label soft-label">
                    Seleccionar Herramienta y Responsable
                    <span class="text-danger">*</span>
                  </label>
                </div>
              </div>
              <div class="row g-3">
                <!-- Herramienta -->
                <div class="col-md-6">
                  <div
                    class="form-field-wrapper"
                    [class.has-value]="prestamoForm.get('herramientaId')?.value"
                    [class.has-error]="
                      prestamoForm.get('herramientaId')?.invalid &&
                      prestamoForm.get('herramientaId')?.touched
                    "
                  >
                    <app-cbo-herramientas
                      [isId]="'herramientaSelect'"
                      [idDisponibilidad]="1"
                      [objectErrors]="prestamoForm.get('herramientaId')?.errors"
                      [isTouched]="!!prestamoForm.get('herramientaId')?.touched"
                      formControlName="herramientaId"
                      (herramientaSelected)="onHerramientaSelected($event)"
                    >
                    </app-cbo-herramientas>
                    <span
                      class="field-check-icon"
                      *ngIf="prestamoForm.get('herramientaId')?.valid"
                    >
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </span>
                  </div>
                  <small class="text-muted"
                    >Solo se muestran herramientas disponibles</small
                  >
                </div>

                <!-- Responsable -->
                <div class="col-md-6">
                  <div
                    class="form-field-wrapper"
                    [class.has-value]="prestamoForm.get('responsableId')?.value"
                    [class.has-error]="
                      prestamoForm.get('responsableId')?.invalid &&
                      prestamoForm.get('responsableId')?.touched
                    "
                  >
                    <app-cbo-usuario
                      [isId]="'responsableSelect'"
                      [showOnlyActive]="true"
                      [objectErrors]="prestamoForm.get('responsableId')?.errors"
                      [isTouched]="!!prestamoForm.get('responsableId')?.touched"
                      formControlName="responsableId"
                      (usuarioSelected)="onUsuarioSelected($event)"
                    >
                    </app-cbo-usuario>
                    <span
                      class="field-check-icon"
                      *ngIf="prestamoForm.get('responsableId')?.valid"
                    >
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <hr class="soft-divider" />

            <!-- SECCIÓN 2: Fechas -->
            <div class="mb-4">
              <h6 class="form-section-title">
                <i class="bi bi-2-circle-fill text-primary me-2"></i>
                Fechas del Préstamo
              </h6>
              <div class="row g-3">
                <!-- Fecha de Préstamo -->
                <div class="col-md-6">
                  <label class="form-label soft-label">
                    Fecha de Préstamo
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group input-group-modern">
                    <span class="input-group-text bg-light border-end-0">
                      <i class="bi bi-calendar3 text-primary"></i>
                    </span>
                    <input
                      type="date"
                      class="form-control border-start-0 ps-0"
                      formControlName="fechaPrestamo"
                      [class.is-invalid]="
                        prestamoForm.get('fechaPrestamo')?.invalid &&
                        prestamoForm.get('fechaPrestamo')?.touched
                      "
                      [class.is-valid]="
                        prestamoForm.get('fechaPrestamo')?.valid &&
                        prestamoForm.get('fechaPrestamo')?.touched
                      "
                    />
                    <span
                      class="input-group-text bg-white border-start-0"
                      *ngIf="prestamoForm.get('fechaPrestamo')?.valid"
                    >
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </span>
                  </div>
                  <div
                    class="invalid-feedback d-block"
                    *ngIf="
                      prestamoForm.get('fechaPrestamo')?.invalid &&
                      prestamoForm.get('fechaPrestamo')?.touched
                    "
                  >
                    <i class="bi bi-exclamation-circle me-1"></i>
                    La fecha de préstamo es requerida
                  </div>
                </div>

                <!-- Fecha Estimada de Devolución -->
                <div class="col-md-6">
                  <label class="form-label soft-label">
                    Fecha Estimada Devolución
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group input-group-modern">
                    <span class="input-group-text bg-light border-end-0">
                      <i class="bi bi-calendar-check text-primary"></i>
                    </span>
                    <input
                      type="date"
                      class="form-control border-start-0 ps-0"
                      formControlName="fechaEstimadaDevolucion"
                      [class.is-invalid]="
                        prestamoForm.get('fechaEstimadaDevolucion')?.invalid &&
                        prestamoForm.get('fechaEstimadaDevolucion')?.touched
                      "
                      [class.is-valid]="
                        prestamoForm.get('fechaEstimadaDevolucion')?.valid &&
                        prestamoForm.get('fechaEstimadaDevolucion')?.touched
                      "
                    />
                    <span
                      class="input-group-text bg-white border-start-0"
                      *ngIf="prestamoForm.get('fechaEstimadaDevolucion')?.valid"
                    >
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </span>
                  </div>
                  <div
                    class="invalid-feedback d-block"
                    *ngIf="
                      prestamoForm.get('fechaEstimadaDevolucion')?.invalid &&
                      prestamoForm.get('fechaEstimadaDevolucion')?.touched
                    "
                  >
                    <i class="bi bi-exclamation-circle me-1"></i>
                    La fecha estimada de devolución es requerida
                  </div>
                  <!-- Alerta si la fecha es muy lejana -->
                  <div
                    class="form-text text-warning mt-2"
                    *ngIf="isDaysExceeded()"
                  >
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    El préstamo excede los 30 días recomendados
                  </div>
                </div>
              </div>
            </div>

            <hr class="soft-divider" />

            <!-- SECCIÓN 3: Obra y Observaciones -->
            <div class="mb-4">
              <h6 class="form-section-title">
                <i class="bi bi-3-circle-fill text-primary me-2"></i>
                Información Adicional
              </h6>
              <div class="row g-3">
                <!-- Obra -->
                <div class="col-md-6">
                  <label class="form-label soft-label"> Obra/Proyecto </label>
                  <div
                    class="form-field-wrapper"
                    [class.has-value]="prestamoForm.get('obraId')?.value"
                  >
                    <app-cbo-obra
                      [isLabel]="'Seleccionar Obra (Opcional)'"
                      [isId]="'obraSelect'"
                      [showOnlyActive]="true"
                      [labelClass]="'soft-label'"
                      formControlName="obraId"
                      (obraSelected)="onObraSelected($event)"
                    >
                    </app-cbo-obra>
                    <span
                      class="field-check-icon"
                      *ngIf="prestamoForm.get('obraId')?.value"
                    >
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </span>
                  </div>
                </div>

                <!-- Observaciones -->
                <div class="col-12">
                  <label class="form-label soft-label"> Observaciones </label>
                  <textarea
                    class="form-control modern-textarea"
                    rows="4"
                    formControlName="observaciones"
                    placeholder=""
                    maxlength="500"
                    (focus)="onTextareaFocus()"
                    (blur)="onTextareaBlur()"
                  >
                  </textarea>
                  <div class="form-text text-end">
                    {{
                      prestamoForm.get("observaciones")?.value?.length || 0
                    }}
                    / 500 caracteres
                  </div>
                </div>
              </div>
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div
              class="form-actions d-flex gap-3 mt-auto border-top justify-content-end"
            >
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="resetForm()"
                [disabled]="isLoading"
              >
                <i class="bi bi-arrow-clockwise me-1"></i>
                <span>Limpiar</span>
              </button>
              <button
                type="submit"
                class="btn btn-success d-flex align-items-center gap-2"
                [disabled]="prestamoForm.invalid || isLoading"
              >
                <span
                  *ngIf="isLoading"
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                <i *ngIf="!isLoading" class="bi bi-check-circle-fill"></i>
                <span>{{
                  isLoading ? "Registrando..." : "Registrar Préstamo"
                }}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- PANEL LATERAL DE INFORMACIÓN -->
    <div class="col-lg-4">
      <!-- Información de la Herramienta -->
      <div
        class="info-card herramienta-card card mb-3 shadow-sm"
        [class.card-skeleton]="!selectedHerramientaInfo"
        [class.card-filled]="selectedHerramientaInfo"
        @fadeIn
      >
        <div class="card-header bg-gradient-primary text-white">
          <h6 class="card-title mb-0 d-flex align-items-center">
            <i class="bi bi-tools me-2"></i>
            Herramienta a Prestar
          </h6>
        </div>
        <div class="card-body">
          <!-- Estado sin selección -->
          <div
            *ngIf="!selectedHerramientaInfo"
            class="empty-state-herramienta text-center text-muted py-4"
          >
            <div class="empty-state-icon mb-3">
              <i class="bi bi-tools" style="font-size: 3rem"></i>
            </div>
            <p class="mb-0 small">
              Seleccione una herramienta para el préstamo
            </p>
          </div>

          <!-- Estado con herramienta seleccionada -->
          <div *ngIf="selectedHerramientaInfo" class="info-content-herramienta">
            <div
              class="alert alert-success d-flex align-items-center mb-3"
              role="alert"
            >
              <i class="bi bi-check-circle-fill me-2"></i>
              <div>
                <strong>Disponible para Préstamo</strong>
                <small class="d-block text-muted"
                  >Herramienta en buen estado</small
                >
              </div>
            </div>

            <div class="info-list-herramienta">
              <div class="info-item-herramienta">
                <span class="info-label-herramienta">
                  <i class="bi bi-hash text-primary"></i> Código:
                </span>
                <span class="info-value-herramienta">{{
                  selectedHerramientaInfo.codigo
                }}</span>
              </div>
              <div class="info-item-herramienta">
                <span class="info-label-herramienta">
                  <i class="bi bi-wrench text-primary"></i> Herramienta:
                </span>
                <span class="info-value-herramienta">{{
                  selectedHerramientaInfo.nombre
                }}</span>
              </div>
              <div class="info-item-herramienta">
                <span class="info-label-herramienta">
                  <i class="bi bi-tag text-primary"></i> Marca:
                </span>
                <span class="info-value-herramienta">{{
                  selectedHerramientaInfo.marca
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información del Responsable -->
      <div
        class="info-card responsable-card card mb-3 shadow-sm"
        *ngIf="selectedUsuarioInfo"
        @fadeIn
      >
        <div class="card-header bg-gradient-info text-white">
          <h6 class="card-title mb-0 d-flex align-items-center">
            <i class="bi bi-person-badge me-2"></i>
            Responsable
          </h6>
        </div>
        <div class="card-body">
          <div class="info-content-responsable">
            <div class="info-list-responsable">
              <div class="info-item-responsable">
                <span class="info-label-responsable">
                  <i class="bi bi-person-vcard text-info"></i> Legajo:
                </span>
                <span class="info-value-responsable">{{
                  selectedUsuarioInfo.legajo
                }}</span>
              </div>
              <div class="info-item-responsable">
                <span class="info-label-responsable">
                  <i class="bi bi-person text-info"></i> Nombre:
                </span>
                <span class="info-value-responsable">
                  {{ selectedUsuarioInfo.nombre }}
                  {{ selectedUsuarioInfo.apellido }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información de la Obra -->
      <div
        class="info-card obra-card card mb-5 shadow-sm"
        *ngIf="selectedObraInfo"
        @fadeIn
      >
        <div class="card-header bg-gradient-warning text-dark">
          <h6 class="card-title mb-0 d-flex align-items-center">
            <i class="bi bi-building me-2"></i>
            Obra Asignada
          </h6>
        </div>
        <div class="card-body">
          <div class="info-content-obra">
            <div class="info-list-obra">
              <div class="info-item-obra">
                <span class="info-label-obra">
                  <i class="bi bi-hash text-warning"></i> Código:
                </span>
                <span class="info-value-obra">{{
                  selectedObraInfo.codigo || "Sin código"
                }}</span>
              </div>
              <div class="info-item-obra">
                <span class="info-label-obra">
                  <i class="bi bi-building text-warning"></i> Nombre:
                </span>
                <span class="info-value-obra">{{
                  selectedObraInfo.nombreObra
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .prestamo-form-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .form-actions {
      margin-top: auto;
    }
  </style>
</div>
