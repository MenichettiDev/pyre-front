<!-- COMPONENTE REPARACIÓN - HTML -->
<div class="container-fluid mt-4 reparacion-container">
    <div class="row g-4 d-flex align-items-stretch">
        <!-- FORMULARIO PRINCIPAL -->
        <div class="col-lg-8">
            <div class="card reparacion-form-card shadow-sm h-100">
                <!-- Header del formulario con indicador de progreso -->
                <div class="card-header border-0 bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-tools text-primary me-2"></i>
                            Datos de la Reparación
                        </h5>
                        <div class="form-progress">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-check-circle-fill text-success me-1" *ngIf="reparacionForm.valid"></i>
                                <i class="bi bi-hourglass-split text-warning me-1" *ngIf="!reparacionForm.valid"></i>
                                {{ getFormCompletionPercentage() }}% completado
                            </span>
                        </div>
                    </div>
                    <!-- Barra de progreso visual -->
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-success transition-smooth" role="progressbar"
                            [style.width.%]="getFormCompletionPercentage()"
                            [attr.aria-valuenow]="getFormCompletionPercentage()" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>

                <div class="card-body p-4 d-flex flex-column">
                    <form [formGroup]="reparacionForm" (ngSubmit)="onSubmit()" class="flex-grow-1">

                        <!-- SECCIÓN 1: Selección de Herramienta y Proveedor -->
                        <div class="mb-4">
                            <h6 class="form-section-title">
                                <i class="bi bi-1-circle-fill text-primary me-2"></i>
                                Herramienta y Proveedor de Reparación
                            </h6>
                            <div class="row g-3">
                                <!-- Labels -->
                                <div class="col-md-6">
                                    <label class="form-label soft-label">
                                        Seleccionar Herramienta a Reparar
                                        <span class="text-danger">*</span>
                                    </label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label soft-label">
                                        Proveedor de Reparación
                                        <span class="text-danger">*</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row g-3">
                                <!-- Herramienta -->
                                <div class="col-md-6">
                                    <div class="form-field-wrapper"
                                        [class.has-value]="reparacionForm.get('herramientaId')?.value"
                                        [class.has-error]="reparacionForm.get('herramientaId')?.invalid && reparacionForm.get('herramientaId')?.touched">
                                        <app-cbo-herramientas [isId]="'herramientaSelect'" [idDisponibilidad]=1
                                            [objectErrors]="reparacionForm.get('herramientaId')?.errors"
                                            [isTouched]="!!(reparacionForm.get('herramientaId')?.touched)"
                                            formControlName="herramientaId"
                                            (herramientaSelected)="onHerramientaSelected($event)">
                                        </app-cbo-herramientas>
                                        <span class="field-check-icon"
                                            *ngIf="reparacionForm.get('herramientaId')?.valid">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        </span>
                                    </div>
                                </div>

                                <!-- Proveedor -->
                                <div class="col-md-6">
                                    <div class="form-field-wrapper"
                                        [class.has-value]="reparacionForm.get('proveedorId')?.value"
                                        [class.has-error]="reparacionForm.get('proveedorId')?.invalid && reparacionForm.get('proveedorId')?.touched">
                                        <app-cbo-proveedor [isLabel]="''" [isId]="'proveedorSelect'"
                                            [objectErrors]="reparacionForm.get('proveedorId')?.errors"
                                            formControlName="proveedorId"
                                            (proveedorSelected)="onProveedorSelected($event)">
                                        </app-cbo-proveedor>
                                        <span class="field-check-icon" *ngIf="reparacionForm.get('proveedorId')?.valid">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="soft-divider">

                        <!-- SECCIÓN 2: Fechas -->
                        <div class="mb-4">
                            <h6 class="form-section-title">
                                <i class="bi bi-2-circle-fill text-primary me-2"></i>
                                Fechas de la Reparación
                            </h6>
                            <div class="row g-3">
                                <!-- Fecha de Inicio Reparación -->
                                <div class="col-md-6">
                                    <label class="form-label soft-label">
                                        Fecha de Inicio de Reparación
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-modern">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="bi bi-calendar3 text-primary"></i>
                                        </span>
                                        <input type="date" class="form-control border-start-0 ps-0"
                                            formControlName="fechaReparacion"
                                            [class.is-invalid]="reparacionForm.get('fechaReparacion')?.invalid && reparacionForm.get('fechaReparacion')?.touched"
                                            [class.is-valid]="reparacionForm.get('fechaReparacion')?.valid && reparacionForm.get('fechaReparacion')?.touched">
                                        <span class="input-group-text bg-white border-start-0"
                                            *ngIf="reparacionForm.get('fechaReparacion')?.valid">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        </span>
                                    </div>
                                    <div class="invalid-feedback d-block"
                                        *ngIf="reparacionForm.get('fechaReparacion')?.invalid && reparacionForm.get('fechaReparacion')?.touched">
                                        <i class="bi bi-exclamation-circle me-1"></i>
                                        La fecha de inicio de reparación es requerida
                                    </div>
                                </div>

                                <!-- Fecha Estimada de Finalización -->
                                <div class="col-md-6">
                                    <label class="form-label soft-label">
                                        Fecha Estimada de Finalización
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-modern">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="bi bi-calendar-check text-primary"></i>
                                        </span>
                                        <input type="date" class="form-control border-start-0 ps-0"
                                            formControlName="fechaEstimadaFinalizacion"
                                            [class.is-invalid]="reparacionForm.get('fechaEstimadaFinalizacion')?.invalid && reparacionForm.get('fechaEstimadaFinalizacion')?.touched"
                                            [class.is-valid]="reparacionForm.get('fechaEstimadaFinalizacion')?.valid && reparacionForm.get('fechaEstimadaFinalizacion')?.touched">
                                        <span class="input-group-text bg-white border-start-0"
                                            *ngIf="reparacionForm.get('fechaEstimadaFinalizacion')?.valid">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        </span>
                                    </div>
                                    <div class="invalid-feedback d-block"
                                        *ngIf="reparacionForm.get('fechaEstimadaFinalizacion')?.invalid && reparacionForm.get('fechaEstimadaFinalizacion')?.touched">
                                        <i class="bi bi-exclamation-circle me-1"></i>
                                        La fecha estimada de finalización es requerida
                                    </div>
                                    <!-- Alerta si la fecha es muy lejana -->
                                    <div class="form-text text-warning mt-2" *ngIf="isDaysExceeded()">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        La reparación excede los 30 días recomendados
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="soft-divider">

                        <!-- SECCIÓN 3: Observaciones -->
                        <div class="mb-4">
                            <h6 class="form-section-title">
                                <i class="bi bi-3-circle-fill text-primary me-2"></i>
                                Observaciones
                            </h6>
                            <div class="row g-3">
                                <!-- Observaciones -->
                                <div class="col-12">
                                    <label class="form-label soft-label">
                                        Observaciones sobre la Reparación
                                    </label>
                                    <textarea class="form-control modern-textarea" rows="4"
                                        formControlName="observaciones" placeholder="" maxlength="500"
                                        (focus)="onTextareaFocus()" (blur)="onTextareaBlur()">
                  </textarea>
                                    <div class="form-text text-end">
                                        {{ reparacionForm.get('observaciones')?.value?.length || 0 }} / 500 caracteres
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <div class="form-actions d-flex gap-3 mt-auto border-top justify-content-end">
                            <button type="button" class="btn btn-outline-secondary" (click)="resetForm()"
                                [disabled]="isLoading">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                <span>Limpiar</span>
                            </button>
                            <button type="submit" class="btn btn-success d-flex align-items-center gap-2"
                                [disabled]="reparacionForm.invalid || isLoading">
                                <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status"
                                    aria-hidden="true"></span>
                                <i *ngIf="!isLoading" class="bi bi-check-circle-fill"></i>
                                <span>{{ isLoading ? 'Registrando...' : 'Registrar Reparación' }}</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PANEL LATERAL DE INFORMACIÓN -->
        <div class="col-lg-4">
            <!-- Card de Estado de Herramienta -->
            <div class="info-card card mb-3 shadow-sm" [class.card-skeleton]="!selectedHerramientaInfo"
                [class.card-filled]="selectedHerramientaInfo">
                <div class="card-header bg-secondary text-white">
                    <h6 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-tools me-2"></i>
                        Herramienta a Reparar
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Estado sin selección -->
                    <div *ngIf="!selectedHerramientaInfo" class="text-center text-muted py-4">
                        <div class="empty-state-icon mb-3">
                            <i class="bi bi-tools" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                        <p class="mb-0 small">Seleccione una herramienta para enviar a reparación</p>
                    </div>

                    <!-- Estado con herramienta seleccionada -->
                    <div *ngIf="selectedHerramientaInfo" class="info-content">
                        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>Requiere Reparación</strong>
                                <small class="d-block text-muted">{{ selectedHerramientaInfo.disponibilidad }}</small>
                            </div>
                        </div>

                        <div class="info-list">
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="bi bi-hash text-primary"></i> Código:
                                </span>
                                <span class="info-value">{{ selectedHerramientaInfo.codigo }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="bi bi-wrench text-primary"></i> Nombre:
                                </span>
                                <span class="info-value">{{ selectedHerramientaInfo.nombre }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="bi bi-tag text-primary"></i> Marca:
                                </span>
                                <span class="info-value">{{ selectedHerramientaInfo.marca }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Información del Proveedor -->
            <div class="info-card card mb-3 shadow-sm" *ngIf="selectedProveedorInfo" @fadeIn>
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-building me-2"></i>
                        Proveedor de Reparación
                    </h6>
                </div>
                <div class="card-body">
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-building text-info"></i> Nombre:
                            </span>
                            <span class="info-value">{{ selectedProveedorInfo.nombreProveedor }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedProveedorInfo.contacto">
                            <span class="info-label">
                                <i class="bi bi-person text-info"></i> Contacto:
                            </span>
                            <span class="info-value">{{ selectedProveedorInfo.contacto }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedProveedorInfo.cuit">
                            <span class="info-label">
                                <i class="bi bi-card-text text-info"></i> CUIT:
                            </span>
                            <span class="info-value">{{ selectedProveedorInfo.cuit }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedProveedorInfo.email">
                            <span class="info-label">
                                <i class="bi bi-envelope text-info"></i> Email:
                            </span>
                            <span class="info-value">{{ selectedProveedorInfo.email }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .reparacion-form-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .form-actions {
        margin-top: auto;
    }
</style>